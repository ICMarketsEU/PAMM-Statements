(window.webpackJsonp=window.webpackJsonp||[]).push([[78],{SGSq:function(t,e,o){"use strict";o.d(e,"b",(function(){return s})),o.d(e,"a",(function(){return r}));var n=o("+GxX");function s(){return"enable_non_unique_watch_sections"}function r(){return Object(n.isFeatureEnabled)("enable_non_unique_watch_sections")}},lnbc:function(t,e,o){"use strict";o("bSeV");var n=o("Eyy1"),s=o("j+67"),r=o("TkhF");class i{constructor(t){this._executing=null,this._destroyed=!1,this._handleChange=()=>{if(this._destroyed)return;const t=this._getCommands();if(t.length>0){if(null!==this._executing)return;const[e,...o]=t;switch(e.type){case"append":this._executing=this._api.appendSymbols(e.color,e.symbols);break;case"remove":this._executing=this._api.removeSymbols(e.color,e.symbols);break;case"replace":this._executing=this._api.replaceSymbols(e.color,e.symbols);break;case"reset":this._executing=this._api.resetSymbols(e.symbols);break;case"rename":this._executing=this._api.renameList(e.color,e.name);break;case"reset-all":this._executing=this._api.resetAll()}this._executing.then(()=>{if(this._executing=null,this._destroyed)return;const[t]=this._getCommands();t===e?this._store.dispatch(Object(s.s)({count:1})):(this._onWarn(`Command: ${JSON.stringify(e)} was sent to the server but is not found in the state`),o.length>0&&this._onWarn(`Commands: ${JSON.stringify(o)} was dropped from state without syncing with server`)),this._handleChange()},t=>{this._destroyed||this._onError(e,t)})}};const{root:e,selector:o,onError:n,onWarn:r,api:i}=t;this._store=e,this._selector=o,this._subscription=this._store.subscribe(this._handleChange),this._onError=n,this._onWarn=r,this._api=i,this._handleChange()}destroy(){this._subscription(),this._destroyed=!0}_getCommands(){const t=this._selector(this._store.getState());return Object(s.e)(t)}}var l=o("txPx");function c(t){return t.ok?204===t.status?Promise.resolve():t.json():t.json().then((function(t){throw new Error(t.detail||"not ok")}))}var a=Object(l.getLogger)("MarkedSymbols.Api"),u=function(){function t(){}return t.prototype.getLists=function(){return fetch("/api/v1/symbols_list/colored/").then(c)},t.prototype.removeSymbols=function(t,e){return 0===e.length?Promise.resolve():(a.logNormal("Sending request to remove symbols from "+t+"-list: "+e),function(t,e){return fetch("/api/v1/symbols_list/colored/"+t+"/remove/",{method:"PATCH",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}}).then(c)}(t,e))},t.prototype.appendSymbols=function(t,e){return 0===e.length?Promise.resolve():(a.logNormal("Sending request to append symbols to "+t+"-list: "+e),function(t,e){return fetch("/api/v1/symbols_list/colored/"+t+"/append/",{method:"PATCH",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}}).then(c)}(t,e))},t.prototype.replaceSymbols=function(t,e){return 0===e.length?Promise.resolve():(a.logNormal("Sending request to replace symbols in "+t+"-list: "+e),function(t,e){return fetch("/api/v1/symbols_list/colored/"+t+"/replace/?unsafe=true",{method:"PATCH",body:JSON.stringify(e),headers:{
"Content-Type":"application/json"}}).then(c)}(t,e))},t.prototype.resetSymbols=function(t){return 0===t.length?Promise.resolve():(a.logNormal("Sending request to reset symbols: "+t),function(t){return fetch("/api/v1/symbols_list/colored/bulk_remove/",{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}}).then(c)}(t))},t.prototype.resetAll=function(){return a.logNormal("Sending request to reset ALL symbols"),fetch("/api/v1/symbols_list/colored/",{method:"DELETE"}).then(c)},t.prototype.renameList=function(t,e){return a.logNormal("Sending request to rename "+t+"-list: "+e),function(t,e){return fetch("/api/v1/symbols_list/colored/"+t+"/rename/",{method:"PATCH",body:JSON.stringify({name:e}),headers:{"Content-Type":"application/json"}}).then(c)}(t,e)},t}(),h=o("TxTq"),m=o.n(h),_=o("PfBM"),p=o("dm8g"),y=(o("NNtz"),o("J/x9")),d=o("ehHn"),b=o("IWXC"),f=o("NP3r"),v=o("bKsZ"),g=o("oOPW"),S=o("SGSq");o.d(e,"d",(function(){return C})),o.d(e,"c",(function(){return w})),o.d(e,"a",(function(){return P})),o.d(e,"b",(function(){return E}));var O,C=500,N=Object(l.getLogger)("MarkedSymbols.Model"),j=null;function w(t){return t.markedLists}var P=function(){function t(t){var e,o,i=this;this._promise=Object(y.a)(),this._service=null,this._executor=null,this._subscription=null,this._state=null,this._sync=null,this._destroyed=!1,this._recover=!1,this._onPushStreamChange=function(t){window.user&&window.user.session_hash!==t&&(N.logNormal("Cross browser sync"),i.syncSymbols())},this._onPushStreamStatus=function(t){var e=Date.now();t===_.ConnectionStatus.Open&&j===_.ConnectionStatus.Closed?(window.is_authenticated&&(O=setTimeout((function(){var t=null!==i._state?Object(s.i)(i._state):null;null===t||t<e?(N.logNormal("Reconnect sync"),i.syncSymbols()):N.logNormal("Reconnect sync handled by another tab")}),30*Math.random()*1e3+3e4)),j=t):t===_.ConnectionStatus.Closed&&(j=t,clearTimeout(O))},this._handleChange=function(){var t,e;if(!i._destroyed){var o=Object(n.ensureNotNull)(i._service).store,s=Object(n.ensureNotNull)(w(o.getState()));if(i._state!==s)try{null===(e=(t=i._opts).onChange)||void 0===e||e.call(t,s,Object(n.ensureNotNull)(i._state))}finally{i._state=s}}},this._handleExecutorError=function(t){i._destroyed||(N.logError("Failed to execute "+t.type),i._recover=!0,i.syncSymbols())},this._opts=t,this._api=t.api||new u,this._session=t.quoteSession||Object(b.getQuoteSessionInstance)("simple"),this._restrictedMarkSymbols=function(t){const{limit:e,colors:o,onLimit:n,onRestrictedColor:i,selector:l}=t;return t=>(c,a)=>{var u,h;const m=a(),_=l(m),{color:p,symbols:y,separators:d}=t;if(null!==p){if(!o().includes(p))return void i();const t=null!==(h=null===(u=_.lists.byColor[p])||void 0===u?void 0:u.symbols)&&void 0!==h?h:[],l=new Set(t),c=s.l.castMany([]);for(const e of new Set(y))!d&&Object(r.a)(e)||l.has(e)||c.push(e);if(c.length+l.size>e())return void n()}c(Object(s.k)(t))}}({selector:function(t){return Object(n.ensureNotNull)(w(t))},limit:null!==(e=t.limit)&&void 0!==e?e:function(){return C},onLimit:function(){var t,e
;N.logNormal("LimitReached"),null===(e=(t=i._opts).onLimit)||void 0===e||e.call(t)},colors:null!==(o=t.colors)&&void 0!==o?o:function(){return s.a.filter(x)},onRestrictedColor:function(){var t,e;null===(e=(t=i._opts).onRestrictedColor)||void 0===e||e.call(t)}}),this._promise.then((function(t){if(!i._destroyed){i._service=t;var e=t.store;i._state=Object(n.ensureNotNull)(w(e.getState())),i._subscription=e.subscribe(i._handleChange)}})),this.connect()}return t.prototype.destroy=function(){this._destroyed=!0,this._sync=null,this._subscription&&this._subscription(),this._executor&&this._executor.destroy(),this.closeConnection()},t.prototype.getSymbolsByColor=function(t){var e;if(null===this._service)return[];var o=w(this._service.store.getState());return null===o?[]:null!==(e=Object(s.h)(o,t))&&void 0!==e?e:[]},t.prototype.getLists=function(){var t=this;return s.a.reduce((function(e,o){return e.set(o,new Set(t.getSymbolsByColor(o))),e}),new Map)},t.prototype.setSymbolsColor=function(t,e){if(N.logNormal("Set symbols color "+e),null!==this._service){var o=this._restrictedMarkSymbols({symbols:t,color:e,separators:!1});this._service.store.dispatch(o)}},t.prototype.markMany=function(t){if(N.logNormal("Mark many symbols: "+t.color),null!==this._service){var e=this._restrictedMarkSymbols(t);this._service.store.dispatch(e)}},t.prototype.getSymbolColor=function(t){if(null===this._service)return null;var e=w(this._service.store.getState());return null===e?null:Object(s.g)(e,t)},t.prototype.clearAllSymbolsColor=function(){N.logNormal("Clear all symbols color"),null!==this._service&&this._service.store.dispatch(Object(s.q)({}))},t.prototype.syncSymbols=function(){var t=this;if(null===this._sync)var e=this._sync=this._synchronize({assert:function(){if(t._sync!==e)throw new Error("ROUTINE_CANCELLED")},cancel:function(){t._sync=null}}).then((function(){t._sync=null}),(function(e){throw t._sync=null,e}));return this._sync},t.prototype.activateSeparators=function(t){null!==this._service&&this._service.store.dispatch(Object(s.c)({value:t}))},t.prototype.anonymize=function(){null!==this._service&&this._service.store.dispatch(Object(s.r)({timestamp:Date.now(),lists:[],separators:Object(S.a)()}))},t.prototype.connect=function(){this._subscribeOnPushStream()},t.prototype.closeConnection=function(){this._unsubscribeOnPushStream()},t.prototype._resolve=function(t){for(var e=this,o=new Set,n=0,s=t;n<s.length;n++){var r=s[n];if(void 0!==r.symbols)for(var i=0,l=r.symbols;i<l.length;i++){var c=l[i];Object(d.o)(c)===c&&o.add(c)}}var a=Array.from(o).map((function(t){return e._session.snapshot(t).then((function(e){return e.pro_name||t}),(function(){return t})).then((function(e){return[t,e]}))}));return Promise.all(a).then((function(e){var o=new Map(e);return t.map((function(t){var e,n=null!==(e=t.symbols)&&void 0!==e?e:[];return{id:t.id,name:t.name,color:t.color,symbols:n.map((function(t){var e;return null!==(e=o.get(t))&&void 0!==e?e:t}))}}))}))},t.prototype._synchronize=function(t){var e=this;return null!==this._executor&&(this._executor.destroy(),
this._executor=null,N.logNormal("Executor was destroyed.")),Promise.all([this._api.getLists(),this._promise,this._recover?Object(p.a)("marked-symbols"):Promise.resolve()]).then((function(o){var n=o[0];return t.assert(),Promise.all([e._resolve(n),Promise.resolve(Date.now())])})).then((function(o){var r=o[0],i=o[1];t.assert(),e._recover=!1;var l=Object(n.ensureNotNull)(e._service).store;null===e._executor&&e._createExecutor();var c=null!==e._state?Object(s.i)(e._state):null;if(!(null!==c&&c>=i)){var a=Object(s.r)({lists:r.map((function(t){var e;return{name:null!==(e=t.name)&&void 0!==e?e:null,color:t.color,symbols:t.symbols}})),timestamp:i,separators:Object(S.a)()});l.dispatch(a)}})).catch((function(t){if(!(t instanceof Error&&(N.logError("Sync symbols error: "+t.message),"ROUTINE_CANCELLED"===t.message)))throw t}))},t.prototype._createExecutor=function(){var t=Object(n.ensureNotNull)(this._service).store;this._executor=new i({root:t,selector:function(t){return Object(n.ensureNotNull)(w(t))},api:this._api,onError:this._handleExecutorError,onWarn:function(t){N.logWarn(t)}}),N.logNormal("Executor was created")},t.prototype._subscribeOnPushStream=function(){m.a.on("marked-symbols",this._onPushStreamChange),m.a.onPrivateStatus(this._onPushStreamStatus)},t.prototype._unsubscribeOnPushStream=function(){m.a.off("marked-symbols",this._onPushStreamChange),m.a.offStatus(this._onPushStreamStatus),clearTimeout(O),j=null},t}();function x(t){return s.b.Red===t||Object(f.enabled)(v.ProductFeatures.MULTIFLAGGED_SYMBOLS_LISTS)}function E(t){return!!x(t)||(Object(g.createGoProDialog)({feature:"flaggedSymbols"}),!1)}}}]);